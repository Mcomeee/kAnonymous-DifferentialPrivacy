# kAnonymous-DifferentialPrivacy
XDU-计科网安方向大数据安全与隐私实验三阶梯三-数据差分隐私处理

## 题目：
1. 数据集：Adult Data Set;
2. 数据发布内容：平均年龄；
3. 针对阶梯二（智能k匿名处理），计算数据集内的平均年龄，与真实年龄进行对比，分析k匿名后平均年龄的可用性；
4. 针对数据集的年龄进行差分隐私发布，分析差分隐私后发布的平均年龄的可用性；
5. 尝试删除某条数据后，k匿名发布的平均年龄、真实发布平均年龄、差分隐私平均年龄对用户隐私信息（年龄）泄露的可能性。

## 实验原理：
### k匿名算法——KACA算法
1. 算法实施：
- 由数据集D中生成初始等价类，等价类中各个元组在准标识符上值相等循环，直到不存在原则个数小于k的等价类随机选择一个大小小于k的等价类C计算C与其他所有等价类的距离直到找到距离C最近的等价类C将C和C’并为一类，并泛化C和C'循环结束
- 在本次实验中，我们还需要建立泛化关系树，最终实现数据集的脱敏。
- KACA的失真度计算：
    $$Distortion=\sum _{i,j\in d}WHD(i,j)$$ d表示元组属性个数
### 差分隐私算法——拉普拉斯噪声
- 为了证明数据集满足差分隐私，我们必须证明产生它的算法满足差分隐私。
- 满足差分隐私的函数通常成为机制。我们说，如果对于所有相邻数据集x和x’以及所有可能的输出S，
$$\frac{Pr[F(x)=S]}{Pr⁡[F(x')=S]}≤e^\varepsilon$$
如果两个数据集中只存在单个个体的数据不同，则将其视为相邻数据集。这个定义的重要含义是F的输出将几乎相同，无论有没有任何特定个人的数据。
为了满足差分隐私的定义，关键的挑战是添加足够多的噪声，但又不能过多地使答案变得过于嘈杂而无用。其中一种机制就被称为拉普拉斯机制。
根据拉普拉斯机制，对于返回数字的函数f(x)，以下F(x)定义满足ϵ-差分隐私：
$$F(x)=f(x)+Lap(\frac{s}{\varepsilon})$$
其中s是f的敏感度，Lap(S)表示从中心为 0 且比例为S的拉普拉斯分布中采样。
对于此次实验的年龄的敏感度，我们可以使用$$\Delta f=max_{D,D'} ||f(D)-f(D')|| $$ 即衡量相邻数据集上查询结果之间的最大差异。
### 差分攻击
针对k-匿名或差分隐私的差分攻击就是：攻击者通过对发布的数据进行查询操作,通过查询结果做差从而推理出隐私数据,造成隐私泄露。最简单的例子就是先查n个人的信息，再查n-1个人的信息，再做差，即$$d=avg_n\times n-avg_{n-1}\times n-1$$

## 操作手册：
### 读取数据：
此时我们使用pandas库中的read_csv方法读取数据。这个方法的好处在于可以读入一个dataframe格式的数据，能够更加清晰明了的对adult data进行展示。
### K匿名模块：
1. 建立泛化树：我们在文档中写入不同属性的泛化程度，并在buidTree函数中进行读取，建立泛化树。不同泛化程度对应不同的根度，为后续失真度计算做准备。
2. 迭代泛化：为了实现更好的泛化结果，在这个函数中，我们默认选择QI列为`['age', 'education', 'marital_status', 'race']`。
  - 首先我们读取泛化树，并且计算每一列的属性值并找到最大值进行泛化，但此时我们只是针对不满足k-匿名的记录组进行泛化，而不是全部的泛化。取出泛化树中对应的泛化强度，并对原数据进行替换。直到所有数据均满足k-匿名，循环结束。
3. 计算精确度和失真度：由于我们使用的KACA，所以通过在泛化树中泛化的层次和公式便可以计算出此次k匿名的失真度。
4. 年龄发布以及差分攻击：
  - 首先我们计算真实平均年龄，和k匿名后的平均年龄(在cac_avg_age函数中，我们将0-25计算为12.5,0-50计算为25，以此类推进行平均年龄的计算)进行比较，对k匿名后的年龄可用性进行评估。
  - 接下来我们删除一条数据，并进行删除数据后的平均年龄计算，最后根据公式倒推出删除的年龄数据，和实际的删除年龄数据进行比较。 
### 差分隐私处理模块：
1. 对年龄添加拉普拉斯噪声：
 - 首先我们计算出该数据集中年龄的敏感度s，使用最大的年龄除以大于requireage年龄的个数。
 - 然后利用numpy库中的`np.random.laplace(self.s/e)`函数给每一条数据添加拉普拉斯噪声。
2. 计算失真度和证明不可分性：
  - 我们运用随机化回答，泛化出了三个数据集D’，分别是删除最大的年龄，26岁年龄和最小的年龄的数据集。
  - 通过这三个数据集和原始数据集的相比和$e^ε$的比较，我们可以得出该算法是满足ε-差分隐私的。
3. 年龄发布以及差分攻击：
  - 在这个模块中，除了和k匿名年龄发布和差分攻击一样的功能，我们还添加了对查询结果的拉普拉斯分布的图形的展示，和删除数据前后的分布的比较。

## 结果：
### K匿名模块
1. k-匿名结果——对`[age,education,education_num,marital,race]`固定脱敏：
 ![image](https://user-images.githubusercontent.com/64068295/175760020-b5566f02-6fd9-4bd6-a2c7-cfa328fa686a.png)
![image](https://user-images.githubusercontent.com/64068295/175760024-627cb793-84c8-493b-b3a3-0b19c3674840.png)

 
2. 排序后的k-匿名结果：
 ![image](https://user-images.githubusercontent.com/64068295/175760028-f470263c-8843-4c25-8115-7d563ab0650d.png)

 
3. 可用性分析
由(2)可以看出，对`[age,education,education_num,marital,race]`进行脱敏数据可用性太差，年龄已经泛化为(0-50)和(50-100)了。
所以我们改为对`[age,education]`两列进行脱敏，分析k匿名后的平均年龄的可用性，以及删除某条数据后年龄泄露的可能性：
 ![image](https://user-images.githubusercontent.com/64068295/175760034-ccf87fff-f0be-4c4d-a455-e2e8a322a58e.png)

删除一条数据之后，根据差分攻击，可以计算出删除的年龄为37.5，和真实年龄相差不大。所以k匿名使年龄泄露的可能性比较大。
### 差分隐私模块：
1. 差分隐私不可分证明
ε=0.5的结果：可知$$\frac{Pr[F(x)=S]}{Pr⁡[F(x')=S]}≤e^\varepsilon=1.6487…$$满足ε-差分隐私。
 ![image](https://user-images.githubusercontent.com/64068295/175760052-887c6bc5-c99a-4715-8076-1015e87333d8.png)

ε=1的结果： 同上理
 ![image](https://user-images.githubusercontent.com/64068295/175760055-0951e03f-59fd-4d4b-af7f-f020c19d909c.png)

2. 可用性分析和差分隐私查询结果
 
在图中我们可以看出删除前后的拉普拉斯分布没有很大的区别，而且计算出的年龄和实际删除的年龄差距很大，说明进行差分隐私处理之后可以有效防御差分攻击。
![image](https://user-images.githubusercontent.com/64068295/175760401-6e57ec9f-a93e-496a-a6e4-7137bedb1a3e.png)![image](https://user-images.githubusercontent.com/64068295/175760408-0d1a3402-6bb8-4950-9d2b-10640687c11d.png)
![image](https://user-images.githubusercontent.com/64068295/175760415-673460eb-1c75-479e-9400-af2755cf6ed2.png)![image](https://user-images.githubusercontent.com/64068295/175760421-4509a182-cf8a-4333-b9a1-549fd5fd6325.png)
![image](https://user-images.githubusercontent.com/64068295/175760431-723c3f47-e537-461d-ae54-70b41b7eebe7.png)






